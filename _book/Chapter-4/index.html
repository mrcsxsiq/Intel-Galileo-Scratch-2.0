
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <title>Backbone of the OS and C++ runtime Â· GitBook</title>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.0">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="../Chapter-5/" />
    
    
    <link rel="prev" href="../Chapter-3/" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../Chapter-1/">
            
                <a href="../Chapter-1/">
            
                    
                    Introduction about the x86 architecture and about our OS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../Chapter-2/">
            
                <a href="../Chapter-2/">
            
                    
                    Setup the development environment
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../Chapter-3/">
            
                <a href="../Chapter-3/">
            
                    
                    First boot with GRUB
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.5" data-path="./">
            
                <a href="./">
            
                    
                    Backbone of the OS and C++ runtime
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../Chapter-5/">
            
                <a href="../Chapter-5/">
            
                    
                    Base classes for managing x86 architecture
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="../Chapter-6/">
            
                <a href="../Chapter-6/">
            
                    
                    GDT
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="../Chapter-7/">
            
                <a href="../Chapter-7/">
            
                    
                    IDT and interrupts
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="../Chapter-8/">
            
                <a href="../Chapter-8/">
            
                    
                    Theory: physical and virtual memory
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="../chapter9/">
            
                <a href="../chapter9/">
            
                    
                    Memory management: physical and virtual
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11" >
            
                <span>
            
                    
                    Process management and multitasking
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.12" >
            
                <span>
            
                    
                    External program execution: ELF files
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.13" >
            
                <span>
            
                    
                    Userland and syscalls
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.14" >
            
                <span>
            
                    
                    Modular drivers
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.15" >
            
                <span>
            
                    
                    Some basics modules: console, keyboard
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.16" >
            
                <span>
            
                    
                    IDE Hard disks
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.17" >
            
                <span>
            
                    
                    DOS Partitions
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.18" >
            
                <span>
            
                    
                    EXT2 read-only filesystems
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.19" >
            
                <span>
            
                    
                    Standard C library (libC)
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.20" >
            
                <span>
            
                    
                    UNIX basic tools: sh, cat
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.21" >
            
                <span>
            
                    
                    Lua interpreter
            
                </span>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Backbone of the OS and C++ runtime</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h2 id="chapter-4-backbone-of-the-os-and-c-runtime">Chapter 4: Backbone of the OS and C++ runtime</h2><h4 id="c-kernel-run-time">C++ kernel run-time</h4><p>A kernel can be written in C++ just as it can be in C, with the exception of a few pitfalls that come with using C++ (runtime support, constructors, etc).</p><p>The compiler will assume that all the necessary C++ runtime support is available by default, but as we are not linking libsupc++ into your C++ kernel, we need to add some basic functions that can be found in the <a href="https://github.com/SamyPesse/How-to-Make-a-Computer-Operating-System/blob/master/src/kernel/runtime/cxx.cc" target="_blank">cxx.cc</a> file.</p><p><strong>Caution:</strong> The operators <code>new</code> and <code>delete</code> cannot be used before virtual memory and pagination have been initialized.</p><h4 id="basic-cc-functions">Basic C/C++ functions</h4><p>The kernel code can&apos;t use functions from the standard libraries so we need to add some basic functions for managing memory and strings:</p><pre><code class="lang-cpp"><span class="hljs-function"><span class="hljs-keyword">void</span>     <span class="hljs-title">itoa</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *buf, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">int</span> n, <span class="hljs-keyword">int</span> base)</span></span>;

<span class="hljs-function"><span class="hljs-keyword">void</span> *    <span class="hljs-title">memset</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *dst,<span class="hljs-keyword">char</span> src, <span class="hljs-keyword">int</span> n)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">void</span> *    <span class="hljs-title">memcpy</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *dst, <span class="hljs-keyword">char</span> *src, <span class="hljs-keyword">int</span> n)</span></span>;

<span class="hljs-function"><span class="hljs-keyword">int</span>     <span class="hljs-title">strlen</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *s)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">int</span>     <span class="hljs-title">strcmp</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *dst, <span class="hljs-keyword">char</span> *src)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">int</span>     <span class="hljs-title">strcpy</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *dst,<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *src)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">void</span>     <span class="hljs-title">strcat</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *dest,<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *src)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">char</span> *    <span class="hljs-title">strncpy</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *destString, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *sourceString,<span class="hljs-keyword">int</span> maxLength)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">int</span>     <span class="hljs-title">strncmp</span><span class="hljs-params">( <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* s1, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* s2, <span class="hljs-keyword">int</span> c )</span></span>;</code></pre>
<p>These functions are defined in <a href="https://github.com/SamyPesse/How-to-Make-a-Computer-Operating-System/blob/master/src/kernel/runtime/string.cc" target="_blank">string.cc</a>, <a href="https://github.com/SamyPesse/How-to-Make-a-Computer-Operating-System/blob/master/src/kernel/runtime/memory.cc" target="_blank">memory.cc</a>, <a href="https://github.com/SamyPesse/How-to-Make-a-Computer-Operating-System/blob/master/src/kernel/runtime/itoa.cc" target="_blank">itoa.cc</a></p><h4 id="c-types">C types</h4><p>In the next step, we&apos;re going to define different types we&apos;re going to use in our code. Most of our variable types are going to be unsigned. This means that all the bits are used to store the integer. Signed variables use their first bit to indicate their sign.</p><pre><code class="lang-cpp"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>     u8;
<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">short</span>     u16;
<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>     u32;
<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span>     u64;

<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">signed</span> <span class="hljs-keyword">char</span>     s8;
<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">signed</span> <span class="hljs-keyword">short</span>     s16;
<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">signed</span> <span class="hljs-keyword">int</span>         s32;
<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">signed</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span>    s64;</code></pre>
<h4 id="compile-our-kernel">Compile our kernel</h4><p>Compiling a kernel is not the same thing as compiling a linux executable, we can&apos;t use a standard library and should have no dependencies to the system.</p><p>Our <a href="https://github.com/SamyPesse/How-to-Make-a-Computer-Operating-System/blob/master/src/kernel/Makefile" target="_blank">Makefile</a> will define the process to compile and link our kernel.</p><p>For x86 architecture, the followings arguments will be used for gcc/g++/ld:</p><pre><code># Linker
LD=ld
LDFLAG= -melf_i386 -static  -L ./  -T ./arch/$(ARCH)/linker.ld

# C++ compiler
SC=g++
FLAG= $(INCDIR) -g -O2 -w -trigraphs -fno-builtin  -fno-exceptions -fno-stack-protector -O0 -m32  -fno-rtti -nostdlib -nodefaultlibs 

# Assembly compiler
ASM=nasm
ASMFLAG=-f elf -o</code></pre>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="../Chapter-3/" class="navigation navigation-prev " aria-label="Previous page: First boot with GRUB">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="../Chapter-5/" class="navigation navigation-next " aria-label="Next page: Base classes for managing x86 architecture">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Backbone of the OS and C++ runtime","level":"1.5","depth":1,"next":{"title":"Base classes for managing x86 architecture","level":"1.6","depth":1,"path":"Chapter-5/README.md","ref":"Chapter-5/README.md","articles":[]},"previous":{"title":"First boot with GRUB","level":"1.4","depth":1,"path":"Chapter-3/README.md","ref":"Chapter-3/README.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["livereload"],"pluginsConfig":{"livereload":{},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"Chapter-4/README.md","mtime":"2015-10-29T16:04:28.000Z","type":"markdown"},"gitbook":{"version":"3.2.0","time":"2016-08-11T06:03:18.076Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-livereload/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

