
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <title>First boot with GRUB Â· GitBook</title>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.0">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="../Chapter-4/" />
    
    
    <link rel="prev" href="../Chapter-2/" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../Chapter-1/">
            
                <a href="../Chapter-1/">
            
                    
                    Introduction about the x86 architecture and about our OS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../Chapter-2/">
            
                <a href="../Chapter-2/">
            
                    
                    Setup the development environment
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.4" data-path="./">
            
                <a href="./">
            
                    
                    First boot with GRUB
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../Chapter-4/">
            
                <a href="../Chapter-4/">
            
                    
                    Backbone of the OS and C++ runtime
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../Chapter-5/">
            
                <a href="../Chapter-5/">
            
                    
                    Base classes for managing x86 architecture
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="../Chapter-6/">
            
                <a href="../Chapter-6/">
            
                    
                    GDT
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="../Chapter-7/">
            
                <a href="../Chapter-7/">
            
                    
                    IDT and interrupts
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="../Chapter-8/">
            
                <a href="../Chapter-8/">
            
                    
                    Theory: physical and virtual memory
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="../chapter9/">
            
                <a href="../chapter9/">
            
                    
                    Memory management: physical and virtual
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11" >
            
                <span>
            
                    
                    Process management and multitasking
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.12" >
            
                <span>
            
                    
                    External program execution: ELF files
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.13" >
            
                <span>
            
                    
                    Userland and syscalls
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.14" >
            
                <span>
            
                    
                    Modular drivers
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.15" >
            
                <span>
            
                    
                    Some basics modules: console, keyboard
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.16" >
            
                <span>
            
                    
                    IDE Hard disks
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.17" >
            
                <span>
            
                    
                    DOS Partitions
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.18" >
            
                <span>
            
                    
                    EXT2 read-only filesystems
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.19" >
            
                <span>
            
                    
                    Standard C library (libC)
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.20" >
            
                <span>
            
                    
                    UNIX basic tools: sh, cat
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.21" >
            
                <span>
            
                    
                    Lua interpreter
            
                </span>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >First boot with GRUB</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h2 id="chapter-3-first-boot-with-grub">Chapter 3: First boot with GRUB</h2><h4 id="how-the-boot-works">How the boot works?</h4><p>When an x86-based computer is turned on, it begins a complex path to get to the stage where control is transferred to our kernel&apos;s &quot;main&quot; routine (<code>kmain()</code>). For this course, we are only going to consider the BIOS boot method and not it&apos;s successor (UEFI).</p><p>The BIOS boot sequence is: RAM detection -&gt; Hardware detection/Initialization -&gt; Boot sequence.</p><p>The most important step for us is the &quot;Boot sequence&quot;, where the BIOS is done with its initialization and tries to transfer control to the next stage of the bootloader process.</p><p>During the &quot;Boot sequence&quot;, the BIOS will try to determine a &quot;boot device&quot; (e.g. floppy disk, hard-disk, CD, USB flash memory device or network). Our Operating System will initially boot from the hard-disk (but it will be possible to boot it from a CD or a USB flash memory device in future). A device is considered bootable if the bootsector contains the valid signature bytes <code>0x55</code> and <code>0xAA</code> at offsets 511 and 512 respectively (called the magic bytes of the Master Boot Record, also known as the MBR). This signature is represented (in binary) as 0b1010101001010101. The alternating bit pattern was thought to be a protection against certain failures (drive or controller). If this pattern is garbled or 0x00, the device is not considered bootable.</p><p>BIOS physically searches for a boot device by loading the first 512 bytes from the bootsector of each device into physical memory, starting at the address <code>0x7C00</code> (1 KiB below the 32 KiB mark). When the valid signature bytes are detected, BIOS transfers control to the <code>0x7C00</code> memory address (via a jump instruction) in order to execute the bootsector code.</p><p>Throughout this process the CPU has been running in 16-bit Real Mode, which is the default state for x86 CPUs in order to maintain backwards compatibility. To execute the 32-bit instructions within our kernel, a bootloader is required to switch the CPU into Protected Mode.</p><h4 id="what-is-grub">What is GRUB?</h4><blockquote><p>GNU GRUB (short for GNU GRand Unified Bootloader) is a boot loader package from the GNU Project. GRUB is the reference implementation of the Free Software Foundation&apos;s Multiboot Specification, which provides a user the choice to boot one of multiple operating systems installed on a computer or select a specific kernel configuration available on a particular operating system&apos;s partitions.</p></blockquote><p>To make it simple, GRUB is the first thing booted by the machine (a boot-loader) and will simplify the loading of our kernel stored on the hard-disk.</p><h4 id="why-are-we-using-grub">Why are we using GRUB?</h4><ul><li>GRUB is very simple to use
</li>
<li>Make it very simple to load 32bits kernels without needs of 16bits code
</li>
<li>Multiboot with Linux, Windows and others
</li>
<li>Make it easy to load external modules in memory
</li></ul>
<h4 id="how-to-use-grub">How to use GRUB?</h4><p>GRUB uses the Multiboot specification, the executable binary should be 32bits and must contain a special header (multiboot header) in its 8192 first bytes. Our kernel will be a ELF executable file (&quot;Executable and Linkable Format&quot;, a common standard file format for executables in most UNIX system).</p><p>The first boot sequence of our kernel is written in Assembly: <a href="https://github.com/SamyPesse/How-to-Make-a-Computer-Operating-System/blob/master/src/kernel/arch/x86/start.asm" target="_blank">start.asm</a> and we use a linker file to define our executable structure: <a href="https://github.com/SamyPesse/How-to-Make-a-Computer-Operating-System/blob/master/src/kernel/arch/x86/linker.ld" target="_blank">linker.ld</a>.</p><p>This boot process also initializes some of our C++ runtime, it will be described in the next chapter.</p><p>Multiboot header structure:</p><pre><code class="lang-cpp"><span class="hljs-keyword">struct</span> multiboot_info {
    u32 flags;
    u32 low_mem;
    u32 high_mem;
    u32 boot_device;
    u32 cmdline;
    u32 mods_count;
    u32 mods_addr;
    <span class="hljs-keyword">struct</span> {
        u32 num;
        u32 size;
        u32 addr;
        u32 shndx;
    } elf_sec;
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> mmap_length;
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> mmap_addr;
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> drives_length;
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> drives_addr;
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> config_table;
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> boot_loader_name;
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> apm_table;
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> vbe_control_info;
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> vbe_mode_info;
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> vbe_mode;
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> vbe_interface_seg;
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> vbe_interface_off;
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> vbe_interface_len;
};</code></pre>
<p>You can use the command <code>mbchk kernel.elf</code> to validate your kernel.elf file against the multiboot standard. You can also use the command <code>nm -n kernel.elf</code> to validate the offset of the different objects in the ELF binary.</p><h4 id="create-a-disk-image-for-our-kernel-and-grub">Create a disk image for our kernel and grub</h4><p>The script <a href="https://github.com/SamyPesse/How-to-Make-a-Computer-Operating-System/blob/master/src/sdk/diskimage.sh" target="_blank">diskimage.sh</a> will generate a hard disk image that can be used by QEMU.</p><p>The first step is to create a hard-disk image (c.img) using qemu-img:</p><pre><code>qemu-img create c.img 2M</code></pre>
<p>We need now to partition the disk using fdisk:</p><pre><code class="lang-bash">fdisk ./c.img

<span class="hljs-comment"># Switch to Expert commands</span>
&gt; x

<span class="hljs-comment"># Change number of cylinders (1-1048576)</span>
&gt; c
&gt; 4

<span class="hljs-comment"># Change number of heads (1-256, default 16):</span>
&gt; h
&gt; 16

<span class="hljs-comment"># Change number of sectors/track (1-63, default 63)</span>
&gt; s
&gt; 63

<span class="hljs-comment"># Return to main menu</span>
&gt; r

<span class="hljs-comment"># Add a new partition</span>
&gt; n

<span class="hljs-comment"># Choose primary partition</span>
&gt; p

<span class="hljs-comment"># Choose partition number</span>
&gt; 1

<span class="hljs-comment"># Choose first sector (1-4, default 1)</span>
&gt; 1

<span class="hljs-comment"># Choose last sector, +cylinders or +size{K,M,G} (1-4, default 4)</span>
&gt; 4

<span class="hljs-comment"># Toggle bootable flag</span>
&gt; a

<span class="hljs-comment"># Choose first partition for bootable flag</span>
&gt; 1

<span class="hljs-comment"># Write table to disk and exit</span>
&gt; w</code></pre>
<p>We need now to attach the created partition to the loop-device using losetup. This allows a file to be access like a block device. The offset of the partition is passed as an argument and calculated using: <strong>offset= start_sector * bytes_by_sector</strong>.</p><p>Using <code>fdisk -l -u c.img</code>, you get: 63 * 512 = 32256.</p><pre><code class="lang-bash">losetup -o 32256 /dev/loop1 ./c.img</code></pre>
<p>We create a EXT2 filesystem on this new device using:</p><pre><code class="lang-bash">mke2fs /dev/loop1</code></pre>
<p>We copy our files on a mounted disk:</p><pre><code class="lang-bash">mount  /dev/loop1 /mnt/
cp -R bootdisk/* /mnt/
umount /mnt/</code></pre>
<p>Install GRUB on the disk:</p><pre><code class="lang-bash">grub --device-map=/dev/null &lt;&lt; EOF
device (hd0) ./c.img
geometry (hd0) 4 16 63
root (hd0,0)
setup (hd0)
quit
EOF</code></pre>
<p>And finally we detach the loop device:</p><pre><code class="lang-bash">losetup <span class="hljs-_">-d</span> /dev/loop1</code></pre>
<h4 id="see-also">See Also</h4><ul><li><a href="http://en.wikipedia.org/wiki/GNU_GRUB" target="_blank">GNU GRUB on Wikipedia</a>
</li>
<li><a href="https://www.gnu.org/software/grub/manual/multiboot/multiboot.html" target="_blank">Multiboot specification</a>
</li></ul>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="../Chapter-2/" class="navigation navigation-prev " aria-label="Previous page: Setup the development environment">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="../Chapter-4/" class="navigation navigation-next " aria-label="Next page: Backbone of the OS and C++ runtime">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"First boot with GRUB","level":"1.4","depth":1,"next":{"title":"Backbone of the OS and C++ runtime","level":"1.5","depth":1,"path":"Chapter-4/README.md","ref":"Chapter-4/README.md","articles":[]},"previous":{"title":"Setup the development environment","level":"1.3","depth":1,"path":"Chapter-2/README.md","ref":"Chapter-2/README.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["livereload"],"pluginsConfig":{"livereload":{},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"Chapter-3/README.md","mtime":"2015-10-29T16:04:28.000Z","type":"markdown"},"gitbook":{"version":"3.2.0","time":"2016-08-11T06:03:18.076Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-livereload/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

