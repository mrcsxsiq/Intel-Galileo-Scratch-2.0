
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <title>Base classes for managing x86 architecture Â· GitBook</title>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.0">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="../Chapter-6/" />
    
    
    <link rel="prev" href="../Chapter-4/" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../Chapter-1/">
            
                <a href="../Chapter-1/">
            
                    
                    Introduction about the x86 architecture and about our OS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../Chapter-2/">
            
                <a href="../Chapter-2/">
            
                    
                    Setup the development environment
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../Chapter-3/">
            
                <a href="../Chapter-3/">
            
                    
                    First boot with GRUB
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../Chapter-4/">
            
                <a href="../Chapter-4/">
            
                    
                    Backbone of the OS and C++ runtime
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.6" data-path="./">
            
                <a href="./">
            
                    
                    Base classes for managing x86 architecture
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="../Chapter-6/">
            
                <a href="../Chapter-6/">
            
                    
                    GDT
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="../Chapter-7/">
            
                <a href="../Chapter-7/">
            
                    
                    IDT and interrupts
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="../Chapter-8/">
            
                <a href="../Chapter-8/">
            
                    
                    Theory: physical and virtual memory
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="../chapter9/">
            
                <a href="../chapter9/">
            
                    
                    Memory management: physical and virtual
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11" >
            
                <span>
            
                    
                    Process management and multitasking
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.12" >
            
                <span>
            
                    
                    External program execution: ELF files
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.13" >
            
                <span>
            
                    
                    Userland and syscalls
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.14" >
            
                <span>
            
                    
                    Modular drivers
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.15" >
            
                <span>
            
                    
                    Some basics modules: console, keyboard
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.16" >
            
                <span>
            
                    
                    IDE Hard disks
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.17" >
            
                <span>
            
                    
                    DOS Partitions
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.18" >
            
                <span>
            
                    
                    EXT2 read-only filesystems
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.19" >
            
                <span>
            
                    
                    Standard C library (libC)
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.20" >
            
                <span>
            
                    
                    UNIX basic tools: sh, cat
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.21" >
            
                <span>
            
                    
                    Lua interpreter
            
                </span>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Base classes for managing x86 architecture</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h2 id="chapter-5-base-classes-for-managing-x86-architecture">Chapter 5: Base classes for managing x86 architecture</h2><p>Now that we know how to compile our C++ kernel and boot the binary using GRUB, we can start to do some cool things in C/C++.</p><h4 id="printing-to-the-screen-console">Printing to the screen console</h4><p>We are going to use VGA default mode (03h) to display some text to the user. The screen can be directly accessed using the video memory at 0xB8000. The screen resolution is 80x25 and each character on the screen is defined by 2 bytes: one for the character code, and one for the style flag. This means that the total size of the video memory is 4000B (80B_25B_2B).</p><p>In the IO class (<a href="https://github.com/SamyPesse/How-to-Make-a-Computer-Operating-System/blob/master/src/kernel/arch/x86/io.cc" target="_blank">io.cc</a>),:</p><ul><li><strong>x,y</strong>: define the cursor position on the screen
</li>
<li><strong>real_screen</strong>: define the  video memory pointer
</li>
<li><strong>putc(char c)</strong>: print a unique character on the screen and manage cursor position
</li>
<li><strong>printf(char* s, ...)</strong>: print a string
</li></ul>
<p>We add a method <strong>putc</strong> to the <a href="https://github.com/SamyPesse/How-to-Make-a-Computer-Operating-System/blob/master/src/kernel/arch/x86/io.cc" target="_blank">IO Class</a> to put a character on the screen and update the (x,y) position.</p><pre><code class="lang-cpp"><span class="hljs-comment">/* put a byte on screen */</span>
<span class="hljs-keyword">void</span> Io::putc(<span class="hljs-keyword">char</span> c){
    kattr = <span class="hljs-number">0x07</span>;
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> *video;
    video = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> *) (real_screen+ <span class="hljs-number">2</span> * x + <span class="hljs-number">160</span> * y);
    <span class="hljs-comment">// newline</span>
    <span class="hljs-keyword">if</span> (c == <span class="hljs-string">&apos;\n&apos;</span>) {
        x = <span class="hljs-number">0</span>;
        y++;
    <span class="hljs-comment">// back space</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (c == <span class="hljs-string">&apos;\b&apos;</span>) {
        <span class="hljs-keyword">if</span> (x) {
            *(video + <span class="hljs-number">1</span>) = <span class="hljs-number">0x0</span>;
            x--;
        }
    <span class="hljs-comment">// horizontal tab</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (c == <span class="hljs-string">&apos;\t&apos;</span>) {
        x = x + <span class="hljs-number">8</span> - (x % <span class="hljs-number">8</span>);
    <span class="hljs-comment">// carriage return</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (c == <span class="hljs-string">&apos;\r&apos;</span>) {
        x = <span class="hljs-number">0</span>;
    } <span class="hljs-keyword">else</span> {
        *video = c;
        *(video + <span class="hljs-number">1</span>) = kattr;

        x++;
        <span class="hljs-keyword">if</span> (x &gt; <span class="hljs-number">79</span>) {
            x = <span class="hljs-number">0</span>;
            y++;
        }
    }
    <span class="hljs-keyword">if</span> (y &gt; <span class="hljs-number">24</span>)
        scrollup(y - <span class="hljs-number">24</span>);
}</code></pre>
<p>We also add a useful and very known method: <a href="https://github.com/SamyPesse/How-to-Make-a-Computer-Operating-System/blob/master/src/kernel/arch/x86/io.cc#L155" target="_blank">printf</a></p><pre><code class="lang-cpp"><span class="hljs-comment">/* put a string in screen */</span>
<span class="hljs-keyword">void</span> Io::print(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *s, ...){
    va_list ap;

    <span class="hljs-keyword">char</span> buf[<span class="hljs-number">16</span>];
    <span class="hljs-keyword">int</span> i, j, size, buflen, neg;

    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> c;
    <span class="hljs-keyword">int</span> ival;
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> uival;

    va_start(ap, s);

    <span class="hljs-keyword">while</span> ((c = *s++)) {
        size = <span class="hljs-number">0</span>;
        neg = <span class="hljs-number">0</span>;

        <span class="hljs-keyword">if</span> (c == <span class="hljs-number">0</span>)
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (c == <span class="hljs-string">&apos;%&apos;</span>) {
            c = *s++;
            <span class="hljs-keyword">if</span> (c &gt;= <span class="hljs-string">&apos;0&apos;</span> &amp;&amp; c &lt;= <span class="hljs-string">&apos;9&apos;</span>) {
                size = c - <span class="hljs-string">&apos;0&apos;</span>;
                c = *s++;
            }

            <span class="hljs-keyword">if</span> (c == <span class="hljs-string">&apos;d&apos;</span>) {
                ival = va_arg(ap, <span class="hljs-keyword">int</span>);
                <span class="hljs-keyword">if</span> (ival &lt; <span class="hljs-number">0</span>) {
                    uival = <span class="hljs-number">0</span> - ival;
                    neg++;
                } <span class="hljs-keyword">else</span>
                    uival = ival;
                itoa(buf, uival, <span class="hljs-number">10</span>);

                buflen = <span class="hljs-built_in">strlen</span>(buf);
                <span class="hljs-keyword">if</span> (buflen &lt; size)
                    <span class="hljs-keyword">for</span> (i = size, j = buflen; i &gt;= <span class="hljs-number">0</span>;
                         i--, j--)
                        buf[i] =
                            (j &gt;=
                             <span class="hljs-number">0</span>) ? buf[j] : <span class="hljs-string">&apos;0&apos;</span>;

                <span class="hljs-keyword">if</span> (neg)
                    print(<span class="hljs-string">&quot;-%s&quot;</span>, buf);
                <span class="hljs-keyword">else</span>
                    print(buf);
            }
             <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (c == <span class="hljs-string">&apos;u&apos;</span>) {
                uival = va_arg(ap, <span class="hljs-keyword">int</span>);
                itoa(buf, uival, <span class="hljs-number">10</span>);

                buflen = <span class="hljs-built_in">strlen</span>(buf);
                <span class="hljs-keyword">if</span> (buflen &lt; size)
                    <span class="hljs-keyword">for</span> (i = size, j = buflen; i &gt;= <span class="hljs-number">0</span>;
                         i--, j--)
                        buf[i] =
                            (j &gt;=
                             <span class="hljs-number">0</span>) ? buf[j] : <span class="hljs-string">&apos;0&apos;</span>;

                print(buf);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (c == <span class="hljs-string">&apos;x&apos;</span> || c == <span class="hljs-string">&apos;X&apos;</span>) {
                uival = va_arg(ap, <span class="hljs-keyword">int</span>);
                itoa(buf, uival, <span class="hljs-number">16</span>);

                buflen = <span class="hljs-built_in">strlen</span>(buf);
                <span class="hljs-keyword">if</span> (buflen &lt; size)
                    <span class="hljs-keyword">for</span> (i = size, j = buflen; i &gt;= <span class="hljs-number">0</span>;
                         i--, j--)
                        buf[i] =
                            (j &gt;=
                             <span class="hljs-number">0</span>) ? buf[j] : <span class="hljs-string">&apos;0&apos;</span>;

                print(<span class="hljs-string">&quot;0x%s&quot;</span>, buf);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (c == <span class="hljs-string">&apos;p&apos;</span>) {
                uival = va_arg(ap, <span class="hljs-keyword">int</span>);
                itoa(buf, uival, <span class="hljs-number">16</span>);
                size = <span class="hljs-number">8</span>;

                buflen = <span class="hljs-built_in">strlen</span>(buf);
                <span class="hljs-keyword">if</span> (buflen &lt; size)
                    <span class="hljs-keyword">for</span> (i = size, j = buflen; i &gt;= <span class="hljs-number">0</span>;
                         i--, j--)
                        buf[i] =
                            (j &gt;=
                             <span class="hljs-number">0</span>) ? buf[j] : <span class="hljs-string">&apos;0&apos;</span>;

                print(<span class="hljs-string">&quot;0x%s&quot;</span>, buf);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (c == <span class="hljs-string">&apos;s&apos;</span>) {
                print((<span class="hljs-keyword">char</span> *) va_arg(ap, <span class="hljs-keyword">int</span>));
            }
        } <span class="hljs-keyword">else</span>
            putc(c);
    }

    <span class="hljs-keyword">return</span>;
}</code></pre>
<h4 id="assembly-interface">Assembly interface</h4><p>A large number of instructions are available in Assembly but there is not equivalent in C (like cli, sti, in and out), so we need an interface to these instructions.</p><p>In C, we can include Assembly using the directive &quot;asm()&quot;, gcc use gas to compile the assembly.</p><p><strong>Caution:</strong> gas uses the AT&amp;T syntax.</p><pre><code class="lang-cpp"><span class="hljs-comment">/* output byte */</span>
<span class="hljs-keyword">void</span> Io::outb(u32 ad, u8 v){
    asmv(<span class="hljs-string">&quot;outb %%al, %%dx&quot;</span> :: <span class="hljs-string">&quot;d&quot;</span> (ad), <span class="hljs-string">&quot;a&quot;</span> (v));;
}
<span class="hljs-comment">/* output word */</span>
<span class="hljs-keyword">void</span> Io::outw(u32 ad, u16 v){
    asmv(<span class="hljs-string">&quot;outw %%ax, %%dx&quot;</span> :: <span class="hljs-string">&quot;d&quot;</span> (ad), <span class="hljs-string">&quot;a&quot;</span> (v));
}
<span class="hljs-comment">/* output word */</span>
<span class="hljs-keyword">void</span> Io::outl(u32 ad, u32 v){
    asmv(<span class="hljs-string">&quot;outl %%eax, %%dx&quot;</span> : : <span class="hljs-string">&quot;d&quot;</span> (ad), <span class="hljs-string">&quot;a&quot;</span> (v));
}
<span class="hljs-comment">/* input byte */</span>
u8 Io::inb(u32 ad){
    u8 _v;       \
    asmv(<span class="hljs-string">&quot;inb %%dx, %%al&quot;</span> : <span class="hljs-string">&quot;=a&quot;</span> (_v) : <span class="hljs-string">&quot;d&quot;</span> (ad)); \
    <span class="hljs-keyword">return</span> _v;
}
<span class="hljs-comment">/* input word */</span>
u16    Io::inw(u32 ad){
    u16 _v;            \
    asmv(<span class="hljs-string">&quot;inw %%dx, %%ax&quot;</span> : <span class="hljs-string">&quot;=a&quot;</span> (_v) : <span class="hljs-string">&quot;d&quot;</span> (ad));    \
    <span class="hljs-keyword">return</span> _v;
}
<span class="hljs-comment">/* input word */</span>
u32    Io::inl(u32 ad){
    u32 _v;            \
    asmv(<span class="hljs-string">&quot;inl %%dx, %%eax&quot;</span> : <span class="hljs-string">&quot;=a&quot;</span> (_v) : <span class="hljs-string">&quot;d&quot;</span> (ad));    \
    <span class="hljs-keyword">return</span> _v;
}</code></pre>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="../Chapter-4/" class="navigation navigation-prev " aria-label="Previous page: Backbone of the OS and C++ runtime">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="../Chapter-6/" class="navigation navigation-next " aria-label="Next page: GDT">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Base classes for managing x86 architecture","level":"1.6","depth":1,"next":{"title":"GDT","level":"1.7","depth":1,"path":"Chapter-6/README.md","ref":"Chapter-6/README.md","articles":[]},"previous":{"title":"Backbone of the OS and C++ runtime","level":"1.5","depth":1,"path":"Chapter-4/README.md","ref":"Chapter-4/README.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["livereload"],"pluginsConfig":{"livereload":{},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"Chapter-5/README.md","mtime":"2015-10-29T16:04:28.000Z","type":"markdown"},"gitbook":{"version":"3.2.0","time":"2016-08-11T06:03:18.076Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-livereload/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

